---
- name: deploy dbworkbench
  hosts: dbworkbench
  tasks:
  - name: get repo sha1
    local_action: command ../get-sha1.sh
    register: sha1
  - name: build
    local_action: command python build.py
  - name: create .initd file
    copy: src=dbworkbench.initd dest=/etc/init.d/dbworkbench owner=root group=root mode=0755
    sudo: yes
  - name: make changes to /etc/init.d/dbworkbench visible
    command: systemctl daemon-reload
    sudo: yes
  - name: create directory for the app
    file: >
      path=/home/dbworkbench/www/app/{{ sha1.stdout }}
      state=directory mode=0755
      owner=dbworkbench group=dbworkbench
  - name: create directory for apps log
    file: >
      path=/home/dbworkbench/www/data/log
      state=directory mode=0755
      owner=dbworkbench group=dbworkbench
  - name: unzip files
    unarchive: src={{ sha1.stdout }}.zip dest=/home/dbworkbench/www/app/{{ sha1.stdout }}
  - name: stop existing
    command: /etc/init.d/dbworkbench stop
    sudo: yes
  - name: stat current
    stat: path=/home/dbworkbench/www/app/current
    register: current_stat
  - name: remove old prev directory
    file: path=/home/dbworkbench/www/app/prev state=absent
  - name: rename current to prev
    command: mv current prev
    when: current_stat.stat.exists
    args:
      chdir: /home/dbworkbench/www/app
  - name: symlink sha1 to current
    file: >
      src=/home/dbworkbench/www/app/{{ sha1.stdout }}
      dest=/home/dbworkbench/www/app/current
      state=link
  - name: start it
    command: /etc/init.d/dbworkbench start
    sudo: yes
  - name: delete .zip file
    local_action: command rm {{ sha1.stdout }}.zip
